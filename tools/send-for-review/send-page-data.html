<!DOCTYPE html>
<html>
<head>
  <title>Send Page Data</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 16px; }
    h2 { margin-bottom: 16px; color: #333; font-size: 16px; }
    .field { margin-bottom: 12px; }
    .field label { display: block; font-weight: 600; margin-bottom: 4px; color: #555; font-size: 12px; }
    .field input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: #fafafa; }
    .actions { display: flex; gap: 10px; margin-top: 16px; }
    button { padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; }
    .btn-primary { background: #0265dc; color: #fff; border: none; }
    .btn-primary:hover { background: #0254b8; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #fff; color: #333; border: 1px solid #ddd; }
    .status { margin-top: 12px; padding: 10px; border-radius: 4px; font-size: 12px; display: none; }
    .status.success { display: block; background: #e6f4ea; color: #1e7e34; }
    .status.error { display: block; background: #fce8e8; color: #c62828; }
    .status.loading { display: block; background: #e3f2fd; color: #1565c0; }
  </style>
</head>
<body>
  <h2>Send Page Data</h2>
  
  <div class="field">
    <label>Title</label>
    <input type="text" id="title" readonly>
  </div>

  <div class="field">
    <label>Name</label>
    <input type="text" id="name" readonly>
  </div>
  
  <div class="field">
    <label>Preview URL</label>
    <input type="text" id="previewUrl" readonly>
  </div>

  <div class="actions">
    <button class="btn-primary" id="sendBtn">Send to Webhook</button>
    <button class="btn-secondary" id="closeBtn">Close</button>
  </div>
  
  <div class="status" id="status"></div>

  <script type="module">
    const RUNTIME_URL = 'https://23750-832emeraldocelot.adobeioruntime.net/api/v1/web/default/fusion-proxy';

    let pageData = {};

    function setStatus(type, message) {
      const status = document.getElementById('status');
      status.className = 'status ' + type;
      status.textContent = message;
    }

    // Get auth token from DA.live's IMS
    async function getAuthToken() {
      // Method 1: Try to get from DA.live's global
      if (window.adobeIMS?.getAccessToken) {
        try {
          const token = await window.adobeIMS.getAccessToken();
          if (token?.token) return token.token;
        } catch (e) { console.log('adobeIMS method failed:', e); }
      }

      // Method 2: Check parent's adobeIMS
      try {
        if (window.parent.adobeIMS?.getAccessToken) {
          const token = await window.parent.adobeIMS.getAccessToken();
          if (token?.token) return token.token;
        }
      } catch (e) { console.log('parent adobeIMS failed:', e); }

      // Method 3: Look in sessionStorage/localStorage
      for (const storage of [sessionStorage, localStorage]) {
        try {
          for (let i = 0; i < storage.length; i++) {
            const key = storage.key(i);
            if (key?.includes('adobeid') || key?.includes('ims') || key?.includes('token')) {
              const val = storage.getItem(key);
              try {
                const parsed = JSON.parse(val);
                if (parsed?.access_token) return parsed.access_token;
                if (parsed?.token) return parsed.token;
              } catch (e) {}
            }
          }
        } catch (e) {}
      }

      return null;
    }

    // Extract context from parent URL: da.live/edit#/org/repo/path
    function getContextFromUrl() {
      try {
        const parentUrl = window.parent.location.href;
        // Pattern: da.live/edit#/org/repo/path or da.live/#/org/repo/path
        const hashMatch = parentUrl.match(/#\/([^\/]+)\/([^\/]+)\/(.+)/);
        if (hashMatch) {
          return {
            org: hashMatch[1],
            repo: hashMatch[2],
            path: '/' + hashMatch[3]
          };
        }
      } catch (e) {
        console.log('Could not access parent URL:', e);
      }
      
      // Fallback: try referrer
      try {
        const ref = document.referrer;
        const hashMatch = ref.match(/#\/([^\/]+)\/([^\/]+)\/(.+)/);
        if (hashMatch) {
          return {
            org: hashMatch[1],
            repo: hashMatch[2],
            path: '/' + hashMatch[3]
          };
        }
      } catch (e) {}

      return null;
    }

    // Initialize: load page data
    async function init() {
      setStatus('loading', 'Loading page data...');

      const ctx = getContextFromUrl();
      
      if (!ctx) {
        setStatus('error', 'Could not determine page context. Please open from DA.live editor.');
        return;
      }

      const { org, repo, path } = ctx;
      const name = path.split('/').pop().replace(/\.html$/, '');
      const previewUrl = `https://main--${repo}--${org}.aem.page${path.replace(/\.html$/, '')}`;

      // Fetch title from preview
      let title = name;
      try {
        const resp = await fetch(previewUrl);
        if (resp.ok) {
          const html = await resp.text();
          const match = html.match(/<title>([^<]*)<\/title>/i);
          if (match) title = match[1].split('|')[0].trim() || name;
        }
      } catch (e) {
        console.log('Title fetch failed:', e);
      }

      pageData = { title, name, previewUrl };

      // Update UI
      document.getElementById('title').value = title;
      document.getElementById('name').value = name;
      document.getElementById('previewUrl').value = previewUrl;
      
      // Clear loading status
      document.getElementById('status').className = 'status';
    }

    // Send data
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      setStatus('loading', 'Sending...');

      try {
        const token = await getAuthToken();

        if (!token) {
          // Try without auth - Runtime will reject if required
          console.warn('No auth token found, attempting without auth');
        }

        const headers = { 'Content-Type': 'application/json' };
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(RUNTIME_URL, {
          method: 'POST',
          headers,
          body: JSON.stringify({ data: pageData })
        });

        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = { error: `HTTP ${response.status}` };
        }

        if (response.ok && result.success) {
          setStatus('success', '✓ Data sent successfully!');
        } else {
          throw new Error(result.error || `HTTP ${response.status}`);
        }
      } catch (e) {
        setStatus('error', '✗ Failed: ' + e.message);
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      window.parent.postMessage({ action: 'close' }, '*');
    });

    // Run init
    init();
  </script>
</body>
</html>