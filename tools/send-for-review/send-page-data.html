<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Send Page Data</title>
  <link rel="icon" href="data:,">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, Helvetica, sans-serif; background: #f7f9fb; color: #333; line-height: 1.5; }
    .card { background: #fff; border: 1px solid #d9e1e2; box-shadow: 0 2px 6px rgba(0,0,0,0.1); min-height: 100vh; }
    .header { display: flex; align-items: center; background: #0265dc; padding: 12px 16px; color: #fff; font-weight: 600; }
    .content { padding: 16px 20px; }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-weight: 600; color: #004b87; margin-bottom: 4px; font-size: 13px; }
    .field input { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: #fafafa; }
    .actions { display: flex; gap: 12px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee; }
    .btn { flex: 1; padding: 10px 20px; font-size: 14px; font-weight: 600; border-radius: 4px; cursor: pointer; border: none; }
    .btn-primary { background: #0265dc; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #0254b8; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #fff; color: #0265dc; border: 1px solid #0265dc; }
    .status { margin-top: 14px; padding: 12px; border-radius: 4px; font-size: 13px; }
    .status--loading { background: #e3f2fd; color: #1565c0; }
    .status--success { background: #e6f4ea; color: #1e7e34; }
    .status--error { background: #fce8e8; color: #c62828; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #1565c0; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">Send Page Data</div>
    <div class="content">
      <div class="field">
        <label>Title</label>
        <input type="text" id="title" readonly>
      </div>
      <div class="field">
        <label>Name</label>
        <input type="text" id="name" readonly>
      </div>
      <div class="field">
        <label>Preview URL</label>
        <input type="text" id="previewUrl" readonly>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="sendBtn" disabled>Send to Webhook</button>
        <button class="btn btn-secondary" id="closeBtn">Close</button>
      </div>
      <div id="status"></div>
    </div>
  </div>

  <script type="module">
    // Adobe I/O Runtime proxy URL
    const RUNTIME_URL = 'https://23750-832emeraldocelot.adobeioruntime.net/api/v1/web/default/fusion-proxy';

    const state = { context: null, pageData: null };

    function setStatus(type, message) {
      const el = document.getElementById('status');
      const spinner = type === 'loading' ? '<span class="spinner"></span>' : '';
      el.className = 'status status--' + type;
      el.innerHTML = spinner + message;
    }

    function clearStatus() {
      document.getElementById('status').className = '';
      document.getElementById('status').innerHTML = '';
    }

    // Build preview URL from context
    function buildPreviewUrl(ctx) {
      const path = ctx.path.replace(/^\/+/, '').replace(/\.html?$/, '');
      return `https://main--${ctx.repo}--${ctx.org}.aem.page/${path}`;
    }

    // Fetch page title from preview URL
    async function fetchPageTitle(previewUrl, fallbackName) {
      try {
        const resp = await fetch(previewUrl);
        if (resp.ok) {
          const html = await resp.text();
          const match = html.match(/<title>([^<]*)<\/title>/i);
          if (match) {
            const title = match[1].split('|')[0].trim();
            if (title) return title;
          }
        }
      } catch (e) {
        console.log('Title fetch failed:', e);
      }
      return fallbackName;
    }

    // Initialize using DA SDK (same pattern as Send For Review)
    async function init() {
      setStatus('loading', 'Loading page context...');

      try {
        // Import DA SDK
        const DA_SDK = await import('https://da.live/nx/utils/sdk.js');
        const sdk = await DA_SDK.default;

        console.log('DA SDK context:', sdk?.context);

        if (!sdk?.context?.org || !sdk?.context?.repo) {
          setStatus('error', 'Could not determine page context. Please open a page in DA.live.');
          return;
        }

        state.context = sdk.context;
        const ctx = state.context;

        // Extract page info
        const path = ctx.path || '';
        const name = path.split('/').pop().replace(/\.html?$/, '') || 'index';
        const previewUrl = buildPreviewUrl(ctx);

        // Fetch title
        const title = await fetchPageTitle(previewUrl, name);

        state.pageData = { title, name, previewUrl };

        // Update UI
        document.getElementById('title').value = title;
        document.getElementById('name').value = name;
        document.getElementById('previewUrl').value = previewUrl;
        document.getElementById('sendBtn').disabled = false;

        clearStatus();

      } catch (error) {
        console.error('Init error:', error);
        setStatus('error', 'Failed to initialize: ' + error.message);
      }
    }

    // Send data to Runtime proxy -> Fusion webhook
    async function sendData() {
      const btn = document.getElementById('sendBtn');
      btn.disabled = true;
      setStatus('loading', 'Sending to webhook...');

      try {
        const response = await fetch(RUNTIME_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: state.pageData })
        });

        let result;
        try {
          result = await response.json();
        } catch (e) {
          result = {};
        }

        if (response.ok && result.success) {
          setStatus('success', '✓ Data sent successfully to Fusion!');
        } else {
          throw new Error(result.error || `HTTP ${response.status}`);
        }
      } catch (e) {
        console.error('Send error:', e);
        setStatus('error', '✗ Failed: ' + e.message);
        btn.disabled = false;
      }
    }

    // Event listeners
    document.getElementById('sendBtn').addEventListener('click', sendData);
    document.getElementById('closeBtn').addEventListener('click', () => {
      window.parent.postMessage({ action: 'close' }, '*');
    });

    // Start
    init();
  </script>
</body>
</html>