<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Send For Review</title>
  <link rel="icon" href="data:,">
  <style>
    :root {
      --color-primary: #00607a;
      --color-primary-dark: #004d61;
      --color-success: #2e7d32;
      --color-success-bg: #e8f5e9;
      --color-error: #c62828;
      --color-error-bg: #ffebee;
      --color-warning: #c67100;
      --color-warning-bg: #fff8e1;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-bg: #ffffff;
      --color-border: #e0e0e0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      min-height: 100vh;
    }
    .review-card { background: var(--color-bg); max-width: 480px; margin: 0 auto; }
    .review-header {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--color-primary);
      padding: 12px 16px;
      color: #fff;
    }
    .logo { display: flex; align-items: center; gap: 6px; }
    .logo-icon {
      width: 28px; height: 28px;
      background: #fff;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo-icon svg { width: 20px; height: 20px; fill: var(--color-primary); }
    .logo-text { font-size: 13px; font-weight: 600; color: #fff; opacity: 0.9; }
    .logo-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.3); margin: 0 4px; }
    .title { font-weight: 600; font-size: 15px; color: #fff; }
    .status-content { padding: 16px; }
    .status-banner {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.5;
    }
    .status-banner.success { background: var(--color-success-bg); color: var(--color-success); border-left: 4px solid var(--color-success); }
    .status-banner.error { background: var(--color-error-bg); color: var(--color-error); border-left: 4px solid var(--color-error); }
    .status-banner.warning { background: var(--color-warning-bg); color: var(--color-warning); border-left: 4px solid var(--color-warning); }
    .status-banner.info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #1565c0; }
    .status-banner-title { font-weight: 600; margin-bottom: 2px; }
    .status-banner-text { font-weight: 400; }
    .status-content.loading { text-align: center; padding: 32px 16px; }
    .status-message { color: var(--color-text-light); font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .info-table { width: 100%; }
    .info-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--color-border); font-size: 14px; }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--color-text); font-weight: 600; min-width: 140px; flex-shrink: 0; }
    .info-value { color: var(--color-text); word-break: break-word; }
    .info-value.warning { color: var(--color-warning); }
    .info-value.success { color: var(--color-success); }
    .info-value .muted { background: #e0e0e0; padding: 2px 8px; border-radius: 3px; font-size: 13px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 20px; font-size: 14px; font-weight: 600;
      border-radius: 4px; border: none; cursor: pointer;
      transition: all 0.2s ease; margin-top: 16px;
    }
    .btn-primary { background: var(--color-primary); color: #fff; width: 100%; }
    .btn-primary:hover { background: var(--color-primary-dark); }
    .btn-secondary { background: #fff; color: var(--color-primary); border: 1px solid var(--color-primary); }
    .btn-secondary:hover { background: #f5f5f5; }
    .btn-group { display: flex; gap: 10px; margin-top: 16px; }
    .btn-group .btn { margin-top: 0; flex: 1; }
    .notes-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
    .notes-label { font-size: 14px; font-weight: 600; color: var(--color-text); margin-bottom: 8px; display: block; }
    .notes-input { width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid var(--color-border); border-radius: 4px; resize: vertical; min-height: 70px; font-family: inherit; }
    .notes-input:focus { outline: none; border-color: var(--color-primary); }
    .notes-display { font-size: 14px; color: var(--color-text); font-style: italic; margin-top: 4px; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; }
    .debug-panel { margin-top: 12px; padding: 10px; background: #fff8e1; border-radius: 4px; font-size: 10px; font-family: monospace; white-space: pre-wrap; word-break: break-all; max-height: 150px; overflow-y: auto; }
    .toggle-debug { font-size: 12px; color: var(--color-text-light); cursor: pointer; margin-top: 12px; text-decoration: underline; }
    .source-badge { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 3px; background: #fff8e1; color: #c67100; font-weight: 500; margin-left: 8px; }
  </style>
</head>
<body>
  <div id="details">
    <div class="review-card">
      <div class="review-header">
        <div class="logo">
          <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg></div>
          <span class="logo-text">SB Tech Labs</span>
        </div>
        <div class="logo-divider"></div>
        <span class="title">Send For Review</span>
      </div>
      <div class="status-content loading">
        <div class="status-message"><div class="spinner"></div><span>Initializing...</span></div>
      </div>
    </div>
  </div>
  <script type="module">
    const CONFIG = {
      webhookUrl: 'https://hook.us2.make.com/d5lqgghlwlcalpy2zw0l7tqukr0u75bd',
      storageKeyPrefix: 'sfr_review_',
      emailStorageKey: 'sfr_user_email',
      defaultRef: 'main',
    };
    let debugLogs = [], currentContext = null, currentAnalysis = null, contentSource = null;

    function log(msg, data = null) {
      const ts = new Date().toISOString().slice(11, 19);
      console.log(`[SFR ${ts}]`, msg, data || '');
      debugLogs.push(data ? `[${ts}] ${msg}: ${JSON.stringify(data).slice(0, 200)}` : `[${ts}] ${msg}`);
    }

    async function getEmailFromParent() {
      return new Promise((resolve) => {
        const timeout = setTimeout(() => resolve(null), 2000);
        const handler = (event) => {
          if (event.data?.type === 'da-user-email' && event.data?.email) {
            clearTimeout(timeout);
            window.removeEventListener('message', handler);
            resolve(event.data.email);
          }
        };
        window.addEventListener('message', handler);
        try { window.parent.postMessage({ type: 'request-user-email' }, '*'); }
        catch (e) { clearTimeout(timeout); window.removeEventListener('message', handler); resolve(null); }
      });
    }

    function getStoredEmail() {
      const sources = [
        () => JSON.parse(sessionStorage.getItem('adobeid_ims_profile'))?.email,
        () => JSON.parse(localStorage.getItem('adobeid_ims_profile'))?.email,
        () => sessionStorage.getItem(CONFIG.emailStorageKey),
        () => localStorage.getItem(CONFIG.emailStorageKey),
        () => JSON.parse(sessionStorage.getItem('da_user'))?.email,
      ];
      for (const src of sources) {
        try { const e = src(); if (e?.includes('@')) return e; } catch {}
      }
      return null;
    }

    function getReviewStateKey(path) { return `${CONFIG.storageKeyPrefix}${(path || 'index').replace(/[\/\\]/g, '_')}`; }
    function getReviewState(path) { try { return JSON.parse(localStorage.getItem(getReviewStateKey(path))); } catch { return null; } }
    function setReviewState(path, state) { localStorage.setItem(getReviewStateKey(path), JSON.stringify({ ...state, timestamp: new Date().toISOString() })); }
    function clearReviewState(path) { localStorage.removeItem(getReviewStateKey(path)); }

    async function checkIfPublished(liveUrl, reviewTimestamp) {
      try {
        const res = await fetch(liveUrl, { method: 'HEAD', cache: 'no-store' });
        const lastMod = res.headers.get('Last-Modified');
        if (lastMod && reviewTimestamp) return new Date(lastMod) > new Date(reviewTimestamp);
        return res.ok;
      } catch { return false; }
    }

    function getContextFromURLParams() {
      const p = new URLSearchParams(window.location.search);
      return { ref: p.get('ref') || '', site: p.get('site') || p.get('repo') || '', org: p.get('org') || p.get('owner') || '', path: p.get('path') || '' };
    }

    function getContextFromReferrer() {
      if (!document.referrer) return null;
      try {
        const url = new URL(document.referrer);
        const daMatch = url.href.match(/da\.live\/edit#\/([^\/]+)\/([^\/]+)\/?(.*)?/);
        if (daMatch) return { org: daMatch[1], site: daMatch[2], path: daMatch[3] || 'index', ref: 'main', source: 'da.live-referrer' };
        const aemMatch = url.host.match(/^([^-]+)--([^-]+)--([^.]+)\.aem\.(page|live)$/);
        if (aemMatch) return { ref: aemMatch[1], site: aemMatch[2], org: aemMatch[3], path: url.pathname.replace(/^\//, '') || 'index', source: 'aem-referrer' };
      } catch {}
      return null;
    }

    async function getContextFromDASDK() {
      try {
        const DA_SDK = await import('https://da.live/nx/utils/sdk.js');
        const sdk = await DA_SDK.default;
        if (sdk?.context) return {
          org: sdk.context.org || sdk.context.owner || '',
          site: sdk.context.repo || '',
          ref: sdk.context.ref || 'main',
          path: sdk.context.path || 'index',
          email: sdk.context.email || sdk.context.user?.email || '',
          source: 'da-sdk'
        };
      } catch {}
      return null;
    }

    async function getFullContext() {
      const urlParams = getContextFromURLParams();
      const referrerCtx = getContextFromReferrer();
      const sdkCtx = await getContextFromDASDK();
      let email = sdkCtx?.email || getStoredEmail() || await getEmailFromParent() || '';

      const ctx = {
        ref: sdkCtx?.ref || referrerCtx?.ref || urlParams.ref || CONFIG.defaultRef,
        site: sdkCtx?.site || referrerCtx?.site || urlParams.site || '',
        org: sdkCtx?.org || referrerCtx?.org || urlParams.org || '',
        path: sdkCtx?.path || referrerCtx?.path || urlParams.path || 'index',
        email,
        source: sdkCtx?.source || referrerCtx?.source || 'url-params',
      };
      if (ctx.path.includes('tools/send-for-review') || ctx.path.includes('send-for-review-library')) ctx.path = 'index';
      ctx.path = ctx.path.replace(/^\/+/, '').replace(/\.html?$/, '') || 'index';
      ctx.previewHost = `${ctx.ref}--${ctx.site}--${ctx.org}.aem.page`;
      ctx.liveHost = `${ctx.ref}--${ctx.site}--${ctx.org}.aem.live`;
      ctx.previewUrl = `https://${ctx.previewHost}/${ctx.path}`;
      ctx.liveUrl = `https://${ctx.liveHost}/${ctx.path}`;
      ctx.plainUrl = `https://${ctx.previewHost}/${ctx.path}.plain.html`;
      ctx.daSourceUrl = `https://admin.da.live/source/${ctx.org}/${ctx.site}/${ctx.path}.html`;
      log('Final context', ctx);
      return ctx;
    }

    async function fetchContent(ctx) {
      const strategies = [
        { url: ctx.previewUrl, source: 'full-page', isPlain: false },
        { url: ctx.plainUrl, source: 'plain.html', isPlain: true },
        { url: ctx.daSourceUrl, source: 'da-source', isPlain: true },
      ];
      for (const s of strategies) {
        try {
          log(`Trying ${s.source}`, s.url);
          const res = await fetch(s.url, { cache: 'no-store' });
          if (res.ok) {
            const html = await res.text();
            log(`${s.source} success`, { length: html.length });
            return { html, source: s.source, isPlain: s.isPlain };
          }
          log(`${s.source} failed`, res.status);
        } catch (e) { log(`${s.source} error`, e.message); }
      }
      return null;
    }

    function analyzeDocument(doc, isPlain) {
      const root = isPlain ? doc.body : (doc.querySelector('main') || doc.body);
      const text = root?.textContent || '';
      const words = text.split(/\s+/).filter(w => w.length > 0);
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 5);

      const contentMetrics = {
        wordCount: words.length,
        characterCount: text.length,
        paragraphCount: root.querySelectorAll('p').length,
        readingTimeMinutes: Math.max(1, Math.ceil(words.length / 200)),
      };

      const headings = [];
      const counts = { h1: 0, h2: 0, h3: 0, h4: 0, h5: 0, h6: 0 };
      const headingIssues = [];
      root.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(h => {
        const level = parseInt(h.tagName[1]);
        counts[`h${level}`]++;
        headings.push({ level, text: h.textContent?.trim().slice(0, 80) || '' });
      });
      if (counts.h1 === 0) headingIssues.push('Missing H1 heading');
      else if (counts.h1 > 1) headingIssues.push(`Multiple H1 headings (${counts.h1})`);
      const headingStructure = { headings, counts, issues: headingIssues };

      const blocks = [], blockSummary = {};
      root.querySelectorAll(':scope > div').forEach((section, i) => {
        section.querySelectorAll(':scope > div[class]').forEach(block => {
          const name = block.classList[0] || 'unknown';
          blocks.push({ name, section: i + 1 });
          blockSummary[name] = (blockSummary[name] || 0) + 1;
        });
      });
      const blocksData = { totalBlocks: blocks.length, blocks, blockNames: [...new Set(blocks.map(b => b.name))], blockSummary };

      const title = doc.querySelector('title')?.textContent?.trim() || '';
      const desc = doc.querySelector('meta[name="description"]')?.content?.trim() || '';
      const lang = doc.documentElement?.lang || '';
      const seoIssues = [];
      if (!title) seoIssues.push('Missing page title');
      else if (title.length < 30) seoIssues.push('Title too short (< 30 chars)');
      else if (title.length > 60) seoIssues.push('Title too long (> 60 chars)');
      if (!desc) seoIssues.push('Missing meta description');
      else if (desc.length < 120) seoIssues.push('Meta description too short (< 120 chars)');
      else if (desc.length > 160) seoIssues.push('Meta description too long (> 160 chars)');
      if (!lang) seoIssues.push('Missing lang attribute');
      const seo = { title: { content: title, length: title.length }, metaDescription: { content: desc, length: desc.length }, lang, issues: seoIssues };

      const images = root.querySelectorAll('img');
      let withAlt = 0, withoutAlt = 0;
      images.forEach(img => { if (img.getAttribute('alt')) withAlt++; else withoutAlt++; });
      const accessibility = { images: { total: images.length, withAlt, withoutAlt }, issues: withoutAlt > 0 ? [`${withoutAlt} images missing alt text`] : [] };

      return { contentMetrics, headingStructure, blocks: blocksData, seo, accessibility, openGraph: {}, links: {}, interactiveElements: {}, analytics: { timestamp: new Date().toISOString() } };
    }

    function buildPayload(ctx, analysis, email, notes = '') {
      const name = ctx.path.split('/').pop() || 'index';
      let title = analysis.seo?.title?.content || name;
      if (!title || title === name) {
        const h1 = analysis.headingStructure?.headings?.find(h => h.level === 1);
        if (h1) title = h1.text;
      }
      return {
        title, name, path: '/' + ctx.path, previewUrl: ctx.previewUrl, liveUrl: ctx.liveUrl,
        reviewSubmissionDate: new Date().toISOString(), submittedBy: email || 'unknown',
        org: ctx.org, site: ctx.site, ref: ctx.ref, source: 'DA.live Library', contentSource: contentSource || 'unknown',
        contentMetrics: analysis.contentMetrics, headingStructure: analysis.headingStructure, blocks: analysis.blocks,
        seo: analysis.seo, accessibility: analysis.accessibility, notes: notes || '',
      };
    }

    async function postToWebhook(payload) {
      const res = await fetch(CONFIG.webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return true;
    }

    function formatDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    function render(state) {
      const details = document.getElementById('details');
      let content = '';

      if (state.status === 'loading') {
        content = `<div class="status-content loading"><div class="status-message"><div class="spinner"></div><span>${state.message}</span></div></div>`;
      }
      else if (state.status === 'in-review') {
        const d = state.data;
        content = `<div class="status-content">
          <div class="status-banner warning"><div class="status-banner-title">Page already in review.</div><div class="status-banner-text">Click "Send Again" to resubmit with updates.</div></div>
          <div class="info-table">
            <div class="info-row"><span class="info-label">Title:</span><span class="info-value">${d.title || d.name}</span></div>
            <div class="info-row"><span class="info-label">Submitted By:</span><span class="info-value">${d.submittedBy === 'unknown' ? '<span class="muted">unknown</span>' : d.submittedBy}</span></div>
            <div class="info-row"><span class="info-label">Submitted On:</span><span class="info-value">${formatDate(d.timestamp)}</span></div>
            ${d.notes ? `<div class="info-row" style="flex-direction:column;"><span class="info-label">Notes:</span><div class="notes-display">${d.notes}</div></div>` : ''}
          </div>
          <div class="btn-group"><button class="btn btn-secondary" id="btn-view-preview">View Preview</button><button class="btn btn-primary" id="btn-send-again">Send Again</button></div>
        </div>`;
      }
      else if (state.status === 'ready') {
        const a = state.analysis;
        const seoIssues = a.seo?.issues?.length > 0 ? a.seo.issues.join(', ') : 'None';
        const seoClass = a.seo?.issues?.length > 0 ? 'warning' : 'success';
        const blocks = a.blocks?.blockNames?.length > 0 ? a.blocks.blockNames.join(', ') : 'None';
        const badge = contentSource === 'da-source' ? '<span class="source-badge">Unpreviewed</span>' : '';
        content = `<div class="status-content">
          <div class="status-banner info"><div class="status-banner-title">Ready to submit for review. ${badge}</div></div>
          <div class="info-table">
            <div class="info-row"><span class="info-label">Title:</span><span class="info-value">${state.title}</span></div>
            <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${state.name}</span></div>
            <div class="info-row"><span class="info-label">SEO Issues:</span><span class="info-value ${seoClass}">${seoIssues}</span></div>
            <div class="info-row"><span class="info-label">Blocks:</span><span class="info-value">${a.blocks?.totalBlocks || 0} (${blocks})</span></div>
          </div>
          <div class="notes-section"><label class="notes-label">Notes (Optional)</label><textarea class="notes-input" id="notes-input" placeholder="Enter any additional notes..."></textarea></div>
          <button class="btn btn-primary" id="btn-submit">Submit for Review</button>
        </div>`;
      }
      else if (state.status === 'success') {
        const p = state.payload;
        const seoIssues = p.seo?.issues?.length > 0 ? p.seo.issues.join(', ') : 'None';
        const seoClass = p.seo?.issues?.length > 0 ? 'warning' : 'success';
        const blocks = p.blocks?.blockNames?.length > 0 ? p.blocks.blockNames.join(', ') : 'None';
        content = `<div class="status-content">
          <div class="status-banner success"><div class="status-banner-title">Review request submitted successfully.</div><div class="status-banner-text">Review in progress.</div></div>
          <div class="info-table">
            <div class="info-row"><span class="info-label">Title:</span><span class="info-value">${p.title}</span></div>
            <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${p.name}</span></div>
            <div class="info-row"><span class="info-label">Submitter:</span><span class="info-value">${p.submittedBy === 'unknown' ? '<span class="muted">unknown</span>' : p.submittedBy}</span></div>
            <div class="info-row"><span class="info-label">Submission Date:</span><span class="info-value">${formatDate(p.reviewSubmissionDate)}</span></div>
            <div class="info-row"><span class="info-label">SEO Issues:</span><span class="info-value ${seoClass}">${seoIssues}</span></div>
            <div class="info-row"><span class="info-label">Blocks:</span><span class="info-value">${p.blocks?.totalBlocks || 0} (${blocks})</span></div>
            ${p.notes ? `<div class="info-row" style="flex-direction:column;"><span class="info-label">Notes:</span><div class="notes-display">${p.notes}</div></div>` : ''}
          </div>
          <button class="btn btn-primary" id="btn-send-again">Send Again</button>
        </div>`;
      }
      else if (state.status === 'error') {
        content = `<div class="status-content">
          <div class="status-banner error"><div class="status-banner-title">Error</div><div class="status-banner-text">${state.message}</div></div>
          <button class="btn btn-primary" id="btn-retry">Retry</button>
          <div class="toggle-debug" id="toggle-debug">Show debug info</div>
          <div class="debug-panel" id="debug-panel" style="display:none;"></div>
        </div>`;
      }

      details.innerHTML = `<div class="review-card">
        <div class="review-header">
          <div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg></div><span class="logo-text">SB Tech Labs</span></div>
          <div class="logo-divider"></div>
          <span class="title">Send For Review</span>
        </div>
        ${content}
      </div>`;

      document.getElementById('btn-send-again')?.addEventListener('click', () => { clearReviewState(currentContext?.path); showReadyState(); });
      document.getElementById('btn-view-preview')?.addEventListener('click', () => window.open(currentContext?.previewUrl, '_blank'));
      document.getElementById('btn-retry')?.addEventListener('click', init);
      document.getElementById('btn-submit')?.addEventListener('click', handleSubmit);
      document.getElementById('toggle-debug')?.addEventListener('click', () => {
        const p = document.getElementById('debug-panel');
        if (p) { p.style.display = p.style.display === 'none' ? 'block' : 'none'; p.textContent = debugLogs.join('\n'); }
      });
    }

    function showReadyState() {
      const name = currentContext.path.split('/').pop() || 'index';
      let title = currentAnalysis.seo?.title?.content || name;
      if (!title || title === name) {
        const h1 = currentAnalysis.headingStructure?.headings?.find(h => h.level === 1);
        if (h1) title = h1.text;
      }
      render({ status: 'ready', title, name, analysis: currentAnalysis });
    }

    async function handleSubmit() {
      const notes = document.getElementById('notes-input')?.value?.trim() || '';
      const email = currentContext.email || getStoredEmail() || 'unknown';
      render({ status: 'loading', message: 'Submitting review…' });
      try {
        const payload = buildPayload(currentContext, currentAnalysis, email, notes);
        await postToWebhook(payload);
        setReviewState(currentContext.path, { title: payload.title, name: payload.name, submittedBy: email, previewUrl: payload.previewUrl, liveUrl: payload.liveUrl, notes });
        render({ status: 'success', payload });
      } catch (err) {
        render({ status: 'error', message: `Failed to submit: ${err.message}` });
      }
    }

    async function init() {
      render({ status: 'loading', message: 'Initializing…' });
      try {
        currentContext = await getFullContext();
        if (!currentContext.org || !currentContext.site) { render({ status: 'error', message: 'Could not determine page context.' }); return; }

        const reviewState = getReviewState(currentContext.path);
        if (reviewState) {
          const published = await checkIfPublished(reviewState.liveUrl, reviewState.timestamp);
          if (published) clearReviewState(currentContext.path);
          else { render({ status: 'in-review', data: reviewState }); return; }
        }

        render({ status: 'loading', message: 'Analyzing page…' });
        const content = await fetchContent(currentContext);
        if (!content?.html) { render({ status: 'error', message: 'Could not fetch page content.' }); return; }

        contentSource = content.source;
        const doc = new DOMParser().parseFromString(content.html, 'text/html');
        currentAnalysis = analyzeDocument(doc, content.isPlain);
        showReadyState();
      } catch (err) {
        render({ status: 'error', message: `Error: ${err.message}` });
      }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  </script>
</body>
</html>